1. 聚合hive存储的用户点击行为日志
2. 按时间间隔(半小时)分割用户点击内容序列
3. 训练 word2vec 模型


```python
import pyspark.sql.functions as F
from pyspark.mllib.feature import Word2VecModel
from pyspark.sql.types import StringType, ArrayType
from pyspark.sql import SparkSession

from pyspark.ml.feature import Word2Vec


spark = SparkSession.builder.appName("spark").master("local[8]")\
    .config("hive.metastore.uris", "thrift://*.*.*.*:9083")\
    .config("hive.metastore.warehouse.dir", "/tmp/hive/warehouse")\
    .config("spark.debug.maxToStringFields", "100")\
    .enableHiveSupport()\
    .getOrCreate()
spark.sparkContext.setLogLevel("INFO")


def get_data():
    get_data_sql = "select muid, collect_set(concat_ws(':', content_id, content_type, flush_time)) as click_records " \
                   "from hive_db.hive_table where day in ('2020-07-02', '2020-07-02', '2020-07-03') and obj_path like '%*whatever*%' and obj_id not in ( " \
                   "'*whatever_obj_id*' ) and muid is not null and content_id is " \
                   "not null and content_id != '' group by muid limit 100 "
    data_df = spark.sql(get_data_sql)
    return data_df


def map_split_click_seq(d):
    # half an hour
    interval = 1800000
    user_all_seq = []
    last_ts = 0
    user_seq = []
    d = sorted(d, key=lambda e: e.split(':')[-1])
    for idx, rec in enumerate(d):
        _splits = rec.split(":")
        if idx == 0:
            # user_seq = [":".join(_splits[:3])]
            user_seq = [":".join(_splits[:2])]
            last_ts = int(_splits[-1])
            continue
        content, ts = ":".join(_splits[:2]), int(_splits[-1])
        if ts - last_ts <= interval:
            # user_seq.append(content + ':{}'.format(ts))
            user_seq.append(content)
        else:
            user_all_seq.append(user_seq)
            # user_seq = [":".join(_splits[:2]) + ':{}'.format(ts)]
            user_seq = [":".join(_splits[:2])]
        last_ts = ts
    user_all_seq.append(user_seq)
    return user_all_seq


udf_parse_record = F.udf(map_split_click_seq, ArrayType(ArrayType(StringType())))

# 1. get data
data = get_data()
# 2. split 
split_df = data.withColumn("click_records_split", udf_parse_record("click_records"))
split_df = split_df.drop("click_records")
# split_df.show(20, False)

# print(split_df.select("click_records_split").dtypes)

# 3. explode
final_df = split_df.withColumn("click_records_explode", F.explode("click_records_split"))
final_df = final_df.drop("click_records_split")

# final_df.show(20, False)
# print(final_df.select("click_records_explode").dtypes)

# 4. train w2v
word2Vec = Word2Vec(vectorSize=50, minCount=3, windowSize=3, maxIter=10,
                    inputCol="click_records_explode", outputCol="word_vector")

model = word2Vec.fit(final_df)

model.save("./content2vec_0701_0703.model")

model.getVectors().show(3, False)

+------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|word                    |vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|whateve1                |[-6.545196520164609E-4,-2.6325834915041924E-4,-5.056314403191209E-4,0.005644617136567831,-0.004990281071513891,-0.010048492811620235,0.005424035247415304,0.003363550640642643,-0.0054877265356481075,-0.0030008158646523952,4.000536573585123E-4,-0.010240713134407997,-0.007850224152207375,0.00663514481857419,-3.4376088296994567E-4,-0.006370019167661667,0.0011146687902510166,-0.00818603951483965,-0.002003777539357543,0.011192788369953632,0.007966266013681889,-0.001818997785449028,-0.01053670048713684,-0.006379429250955582,-0.0050387075170874596,-0.008009477518498898,0.0025601580273360014,-0.0015365243889391422,-0.008093801327049732,-0.005782160442322493,-0.0030228651594370604,0.008624637499451637,-0.008290579542517662,-0.010697085410356522,-0.0016660571563988924,0.011450616642832756,-0.0013513877056539059,2.232785918749869E-4,-0.008815072476863861,1.6997617785818875E-4,0.005013228859752417,-0.008618878200650215,-0.0111685236915946,-0.004440241493284702,-0.008680065162479877,-0.012215232476592064,2.049317117780447E-6,-0.0049467445351183414,-0.0031605400145053864,-4.999519442208111E-4]|
|whateve2                |[-0.004122951999306679,-0.009685144759714603,-0.00807582400739193,0.004690252710133791,0.005874316673725843,-0.009531905874609947,-0.00410531647503376,0.0019948375411331654,0.001718838233500719,0.004525288473814726,0.0071992590092122555,-0.009632631205022335,-0.007525695487856865,-0.008403604850172997,-0.007121821865439415,-0.0011500573018565774,-0.0032442533411085606,-0.008650691248476505,-0.005845322739332914,-0.005017617717385292,0.009070186875760555,0.0020964813884347677,0.005461848806589842,-0.008311802521348,0.009346800856292248,0.001096984138712287,-0.002030052011832595,-1.171994226751849E-4,-0.002507166936993599,-0.0010975372279062867,-0.005556254182010889,0.00781333353370428,0.00591525062918663,-0.007509544957429171,-9.214866440743208E-4,0.0034915339201688766,0.007046196609735489,0.007980802096426487,5.152225494384766E-4,0.005989470519125462,0.005318675190210342,2.0903348922729492E-4,-0.009951746091246605,0.00966492760926485,0.003011879976838827,-0.005949484184384346,-0.006051670294255018,-0.008360825479030609,0.009555429220199585,-2.3523211712017655E-4]                |
|whateve3                |[0.0038844957016408443,0.006010234821587801,-0.009501611813902855,0.0016769572393968701,7.341437740251422E-4,0.0021163076162338257,2.1565300994552672E-4,-3.530565882101655E-4,-0.006089338567107916,0.006230547558516264,-0.008213728666305542,0.0016105568502098322,-0.009758813306689262,-0.010263505391776562,0.009109985083341599,-0.009609783068299294,-0.005256783217191696,-0.011281606741249561,0.014381634071469307,0.00885444600135088,0.0038578698877245188,0.0030054685194045305,0.0069895777851343155,0.009418121539056301,0.005785265006124973,0.0018866760656237602,0.0017711326945573092,-0.0024864450097084045,-0.0025019305758178234,-0.004665135871618986,-0.002364968415349722,0.009809321723878384,0.011477257125079632,-0.006836950778961182,0.008755718357861042,-0.002791658043861389,0.006723438389599323,-0.006725545972585678,-0.008141704834997654,3.0102732125669718E-5,-1.0146071144845337E-4,0.0014016036875545979,0.0019435782451182604,-0.013635003939270973,0.005434026475995779,-6.30817492492497E-4,0.006813518237322569,-0.00932204257696867,7.953331805765629E-4,0.0031939796172082424]         |
+------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

```
