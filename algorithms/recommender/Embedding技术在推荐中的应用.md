最近看了一篇Embedding技术在民宿推荐中的应用，和我们当前的业务-旅游(自驾)信息流推荐，有一定的相似性。
旅游需求具有相对低频的特点，因此一些协同过滤尤其是U2U的效果可能不太理想，而I2I的结果又偏向热门推荐，而且从目前的实验中看到在旅游场景下I2I的结果可能主要突出的是地理位置的相关性，对于其他潜在维度的挖掘比较有限。
基于Emedding来做相关推荐也是我在最近的工作中一直在考虑和调研的，SkipGram、GraphEmbedding、nmslib、FAISS等基础技术最近也都尝试了个遍，这篇文章也对接下来的工作有了更多的启发，在这里记录一些个人觉得比较重要的点。
#### 1. 从用户行为构建Embedding模型的合理性
用户在短时间内会浏览很多房子，我们认为，用户在下单前，他的搜索都是基于同一个需求的，所以在短时间内浏览的房子是具有内在相似性的。
这里的短时间可以是同一个session_id、action_id或半个小时以内，具体怎么定义也可以在和产品沟通之后再确定下来。
#### 2. 行为序列数据处理
在我们的业务中，这个序列其实就是一个个房子，就是用户在列表页看到的房子，并且是点击过的房子，黄色为用户跳过的房子(浏览未点击)，这样就和我们的语言模型对应上了，也有正样本和负样本。
一般的埋点数据会分成show(exposure)和click两个事实表来记录曝光(浏览)和点击行为。需要对这两张表进行聚合和清洗，这里再补充一些数据建模的的处理方法或技巧：
- 连续的浏览点击行为作为单一需求上下文
- 若两个行为间隔在半小时以上，则分到两个不同需求上下文中
- 一个上下文中点击的房子作为正样本，跳过的房子作为负样本
- 当天下单的房子作为当天所有上下文的正样本 wa ，且权重更大(当作 5 个点击)
- **过滤掉停留时长太短的点击行为**
- **过滤掉点击数量太多的用户行为**
- **上下文不能太长：+/-2 个点击, 行为间隔<30 分钟**
- **下单参与到用户当天所有上下文中**

#### 3. 模型应用中的一些技巧
- 预测前需要对所有 Embedding 向量规范化
- 过滤掉在训练集中总出现次数小于 10 的房子
- **对用户一天内最近 5 次点过的房子向量求均值，再求与候选房子的相似度**
- 为每个用户生成固定数量的训练样本。为每个用户固定样本数量上限，平等地对待每个用户，避免loss被少数活跃用户代表，能明显提升线上效果，这个方法有点类似协同过滤中对活跃用户的惩罚。

#### 4. **冷启动**问题
由于不可能实时训练Embedding模型，因此需要考虑新数据的冷启动问题，文中给到的一个方法为：
- 找到与新上房子最接近的房子小集合，对小集合中的 Embedding向量求均值作为该新房子的 Embedding 向量
- **小集合确定方法**：在距离，房型，价格，图片分，面积，人数等已有数据方面尽量接近

#### 5. **非常重要的一点:  Embedding 的持续迭代更新**
- 收集最近 2 月的用户行为日志，生成新训练样本
- 预加载上一版模型参数，**新增的 p 个房子补充到参数矩阵末尾随机初始化**
- 只用新训练样本进行训练，导出 Embedding 矩阵同步到线上推荐模型

这样做的好处：
- 老的房子向量可以存留和持续更新
- 及时加入新的房子向量

#### 6. Embedding结果的评价
 - 评估地理位置相似性是否被包含，对Embedding进行了 k 均值聚类 (k-means clustering)
 - 评估数据业务类型特征相似性是否被包含。论文评估了不同类型的内容之间的平均余弦相似性 (cosine similarity) ，并确认相同类型的内容之间的余弦相似性远高于不同类型内容之间的相似性
 
#### 7. 如何学习含有长期兴趣信息的Embedding
 - 通过clicked session学习到的Embedding只包含短期偏好信息，不包含用户的长期偏好。所以为了学习有着用户长期偏好信息Embedding，Airbnb的方案是利用booking session数据。如果用户有过下单历史，说明其对该类型的数据可能更感兴趣。

#### 8. 如何让物品和地理信息(目的地)共享相同的语义空间
可以考虑把原来的物品序列 [uid, uid, ...] 处理为 [(uid, city_id), (uid, city_id), ...] 这样的元组序列，这样就可以让uid和其对应的地理信息的相对位置保持一致，最终可以得到物品和地理信息两种embedding，可谓一箭双雕。

